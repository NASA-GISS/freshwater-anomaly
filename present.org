#+TITLE: Freshwater Anomalies
#+AUTHOR: K. D. Mankoff

#+EMAIL:  ken.mankoff@nasa.gov
#+DATE: \tiny{ {{{time(%Y-%m-%d)}}} version:\input{|"git describe --always --dirty='*'"} } 

# version:\input{|"git describe --always --dirty='*'"}}}}}
# #+DATE: \tiny{2020-02-05} @@latex:\\@@ { \tiny version:\input{|"git describe --always --dirty='*'"}}

#+MACRO: NEWLINE @@latex:\\@@ @@html:<br>@@
#+MACRO: SKIPLINE @@latex:\\\vspace{\baselineskip}@@

#+DESCRIPTION:
#+KEYWORDS:
#+LANGUAGE:  en
#+OPTIONS:   H:2 num:nil ^:{} toc:nil

#+EXCLUDE_TAGS: noexport
#+ARCHIVE: ::* Archive

#+PROPERTY: header-args :eval no-export :noweb yes
# #+PROPERTY: header-args:jupyter-python :session MC-LOB :eval no-export :noweb yes :exports results :results raw drawer
# #+PROPERTY: header-args:jupyter-python+ :var datadir="/home/kdm/projects/freshwater/freshwater/runoff/"

* COMMENT Table of contents                       :toc_2:noexport:
- [[#introduction][Introduction]]
  - [[#summary][Summary]]
  - [[#global-ice-mass-change][Global ice mass change]]
  - [[#slater-2021-fig-4-recreation][Slater 2021 Fig. 4 recreation]]
  - [[#issues][Issues]]
- [[#greenlandic-grounded-ice][Greenlandic grounded ice]]
  - [[#mankoff-2021][Mankoff 2021]]
  - [[#fetch-historical-observations][Fetch historical observations]]
  - [[#compare-mankoff-2021--slater-2021][Compare Mankoff 2021 & Slater 2021]]
  - [[#process-to-modele-format][Process to ModelE format]]
- [[#greenlandic-peripheral-glaciers][Greenlandic peripheral glaciers]]
  - [[#greenlandic-peripheral-glaciers-1][Greenlandic Peripheral glaciers]]
- [[#arctic-sea-ice][Arctic sea ice]]
  - [[#arctic-sea-ice-1][Arctic sea ice]]
- [[#freshwater-distribution-mask][Freshwater distribution mask]]
  - [[#introduction-1][Introduction]]
  - [[#modele-mask][ModelE Mask]]
  - [[#contents-of-glmelt_4x5ocnnc][Contents of GLMELT_4X5.OCN.nc]]
  - [[#visualization-of-glmelt_4x5ocnnc][Visualization of GLMELT_4X5.OCN.nc]]
  - [[#contents-of-glmelt_144x90_gasocnnc][Contents of GLMELT_144X90_gas.OCN.nc]]
  - [[#visualization-of-glmelt_144x90_gasocnnc][Visualization of GLMELT_144X90_gas.OCN.nc]]
  - [[#actual-distribution-of-melt-greenland][Actual distribution of melt (Greenland)]]
  - [[#mask-editing][Mask editing]]
- [[#antarctica][Antarctica]]
  - [[#imbie-2018][IMBIE 2018]]
  - [[#imbie-2018-vs-slater-2021][IMBIE 2018 vs Slater 2021]]
- [[#summary-1][Summary]]
  - [[#question][Question]]
  - [[#to-do][To Do]]
- [[#appendix][Appendix]]
  - [[#references][References]]
  - [[#about-this-document][About This Document]]
- [[#latex-header][LaTeX Header]]
  - [[#beamer][Beamer]]
  - [[#references-1][References]]
  - [[#hyperref][Hyperref]]
  - [[#tweak-references][Tweak References]]
  - [[#background-block][Background Block]]
  - [[#code-export][Code export]]
- [[#local-variables][Local Variables]]

* Introduction
** Summary

This workbook computes freshwater anomaly from Greenland and Antarctica for the NASA GISS ModelE.

+ Anomaly is defined as mass loss since [TBD]
+ Temporal resolution is annual
+ Spatially, ModelE distributes a single value according to a 'distribution field' - a floating point mask that sums to 1.

** Global ice mass change

citet:slater_2021 track global ice mass change from 1994 through 2017 including floating and grounded.

+ Paper: https://doi.org/10.5194/tc-15-233-2021
+ Data: Shared via email (pers. comm.)

** Slater 2021 Fig. 4 recreation
*** Original                                               :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

**** Original

[[./fig/slater_2021_fig4_orig.png]]


*** Recreation                                             :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:
**** Recreation

#+BEGIN_SRC jupyter-python :results file :exports results
import pandas as pd

kw = {'parse_dates':True, 'index_col':0}
SH_ice = pd.read_csv('./input/SH_seaice_cumul_1994_2017_annual.csv', names=['Antarctic Sea Ice'], **kw)
NH_ice = pd.read_csv('./input/NH_seaice_cumul_1994_2017_annual.csv', names=['Arctic Sea Ice'], **kw)
shelf_calving = pd.read_csv('./input/iceshelves_calving_cumul_1994_2017_annual.csv', names=['Ice Shelf Calving'], **kw)
shelf_thinning = pd.read_csv('./input/iceshelves_thinning_cumul_1994_2017_annual.csv', names=['Ice Shelf Thinning'], **kw)
AQ = pd.read_csv('./input/AIS_cumul_1994_2017_annual.csv', names=['Antarctica'], **kw)
GL = pd.read_csv('./input/GrIS_cumul_1994_2017_annual.csv', names=['Greenland'], **kw)
glacier = pd.read_csv('./input/Glacier_cumul_1994_2017_annual.csv', names=['Glaciers'], **kw)

kw = {'left_index':True, 'right_index':True, 'how':'outer'}
df = SH_ice.merge(NH_ice, **kw)\
           .merge(shelf_calving, **kw)\
           .merge(shelf_thinning, **kw)\
           .merge(AQ, **kw)\
           .merge(GL, **kw)\
           .merge(glacier, **kw)
df.index.name = 'Date'

# df.plot.area() # NO
# Split positive and negative and plot separately but visually combined
# https://stackoverflow.com/questions/52872938/
import matplotlib.pyplot as plt
fig, ax = plt.subplots()
cm = 'GnBu'
df_neg, df_pos = df.clip(upper=0), df.clip(lower=0)
df_pos.plot.area(ax=ax, stacked=True, linewidth=0., cmap=cm)
ax.set_prop_cycle(None)
ax.set_ylim([-30000, 5000])
df_neg.plot.area(ax=ax, stacked=True, linewidth=0., legend=False, cmap=cm)
ax.set_ylim([-30000, 5000])
plt.hlines(0, 0, 1E3, color='k', linewidth=1, alpha=0.33, linestyles='dashed')
ax.set_ylabel('Mass change [Gt]')

plt.savefig('./fig/slater_2021_fig4.png', dpi=150)
#+END_SRC

#+RESULTS:
[[file:./.ob-jupyter/8924bac88c2c80f0af2e9f1a129c0909edec3f80.png]]



** Issues

+ Although citet:slater_2021 provide global ice mass change, the data is only from 1994 through 2017
+ We will use other products with longer records, but use citet:slater_2021 for QC

* Greenlandic grounded ice
** Mankoff 2021

citet:mankoff_2021 provide *main ice sheet* mass loss from 1840 through next week.

{{{SKIPLINE}}}

+ Paper: https://doi.org/10.5194/essd-13-5001-2021
+ Data: https://doi.org/10.22008/FK2/OHI23Z v439

** Fetch historical observations                        :noexport:

#+BEGIN_SRC bash
mkdir input
wget -nc  https://dataverse.geus.dk/api/access/datafile/:persistentId?persistentId=doi:10.22008/FK2/OHI23Z/NBMCEK -O ./input/mankoff_2021.csv

wget -nc https://dataverse.geus.dk/api/access/datafile/:persistentId?persistentId=doi:10.22008/FK2/OHI23Z/XQHQOB  -O ./input/mankoff_2021.nc
#+END_SRC

#+RESULTS:

** Compare Mankoff 2021 & Slater 2021
*** Figure                                                 :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+BEGIN_SRC jupyter-python :exports results
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
fig, (ax, ax2) = plt.subplots(nrows=2, figsize=(4,5))

kw = {'parse_dates':True, 'index_col':0}
S2021 = pd.read_csv('./input/GrIS_cumul_1994_2017_annual.csv', names=['Slater GrIS'], **kw)
M2021 = pd.read_csv('./input/mankoff_2021.csv', **kw)
M2021 = M2021['MB'].rename('Mankoff 2021').resample('YS').sum()['1990':'2022-12-31'].cumsum()

df = S2021.merge(M2021, left_index=True, right_index=True, how='outer')
df.index.name = 'Date'

for _ in df.columns: # extend by 1 year for plotting w/ 'step'
    df.loc[df[_].dropna().index[-1] + pd.offsets.DateOffset(years=1),_] = df[_].dropna().iloc[-1]

kw = {'drawstyle':'steps'}
(df['Slater GrIS']).diff().plot(ax=ax, **kw)
(df['Mankoff 2021']).diff().plot(ax=ax, **kw)
ax.set_ylabel('Annual\nmass change [Gt]')
(df['Mankoff 2021'].diff() - df['Slater GrIS'].diff()).plot(ax=ax, linestyle='--', color='k', alpha=0.5, **kw)

(df['Slater GrIS'] + df['Mankoff 2021'].loc['1994'].values).plot(ax=ax2, **kw)
df['Mankoff 2021'].plot(ax=ax2, **kw)
ax2.legend(['Slater 2021','Mankoff 2021'])
_ = ax2.set_ylabel('Cumulative\nmass change [Gt]')
axr = ax2.twinx()
axr.set_ylim(np.array(ax2.get_ylim()).astype(float)/-362)
_ = axr.set_ylabel('SLR [mm]')
#+END_SRC

#+RESULTS:
[[file:./.ob-jupyter/45a68d209381e2ce505acad99c97c85354e3c57c.png]]


*** Text                                                   :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

+ Upper panel: annual change (and difference between two products [dashed gray])
+ Lower panel: cumulative

** Process to ModelE format                             :noexport:

#+BEGIN_SRC jupyter-python
import pandas as pd
df = pd.read_csv('./input/mankoff_2021.csv',
                 parse_dates = True,
                 index_col = 0)

df = df.loc['1990-01-01':'2020-12-31']
df = df.resample('YS').sum()
df = df['MB']
df
#+END_SRC

#+RESULTS:
#+begin_example
time
1990-01-01   -138.730546
1991-01-01    -78.035251
1992-01-01     86.510696
1993-01-01    -91.168942
1994-01-01   -113.813365
1995-01-01   -212.258811
1996-01-01    131.861276
1997-01-01      7.228484
1998-01-01   -242.034055
1999-01-01    -47.090412
2000-01-01    -77.221410
2001-01-01    -26.031650
2002-01-01   -142.376845
2003-01-01   -167.267936
2004-01-01   -166.197877
2005-01-01   -168.408093
2006-01-01   -239.836278
2007-01-01   -257.300333
2008-01-01   -199.784137
2009-01-01   -241.123712
2010-01-01   -374.126750
2011-01-01   -330.186274
2012-01-01   -425.403462
2013-01-01   -100.150906
2014-01-01   -182.195958
2015-01-01   -213.177325
2016-01-01   -255.469501
2017-01-01   -101.391264
2018-01-01    -72.974441
2019-01-01   -411.930477
2020-01-01   -173.929899
Freq: AS-JAN, Name: MB, dtype: float64
#+end_example


* Greenlandic peripheral glaciers
** Greenlandic Peripheral glaciers

+ Need to determine where Greenlandic peripheral glaciers are in the citet:slater_2021 data
  + [ ] Greenland?
  + [ ] Glaciers?
+ If needed, can include as a scaling factor from citet:mankoff_2021 main ice sheet mass balance

* Arctic sea ice
** Arctic sea ice

+ Provided by citet:slater_2021
+ Does it need to be included in the anomaly product
  + Does it need its own distribution mask?

* Freshwater distribution mask
** Introduction

+ ModelE distributes Greenlandic melt via a fractional mask (sums to 1)
+ We can use the same mask to distribute the freshwater anomaly
+ However, the anomaly is distributed differently than the baseline
+ For example, Fig. 1 of citet:mankoff_2021 shows the SE (/included below/) has no net mass loss, and no change from <1990 baseline. However, SE should still have an annual baseline meltwater volume flow rate, because winter snowfall is offset by summer melt.

#+ATTR_LATEX: :height 3cm
[[./fig/mankoff_2021_fig1_orig.png]]

** ModelE Mask

+ Probably =GLMELT_4X5.OCN.nc= (ROCKE-3D) or =GLMELT_144X90_gas.OCN.nc= (ModelE)
  + Source: https://portal.nccs.nasa.gov/GISS_modelE/modelE_input_data/

** Contents of GLMELT_4X5.OCN.nc
:PROPERTIES:
:BEAMER_opt: shrink=8
:END:

#+BEGIN_SRC bash :exports results :results verbatim
ncdump dat/GLMELT_4X5.OCN.nc | head -n30
echo "[...]"
#+END_SRC

#+RESULTS:
#+begin_example
netcdf GLMELT_4X5.OCN {
dimensions:
	lon = 72 ;
	lat = 46 ;
variables:
	float lon(lon) ;
		lon:units = "degrees_east" ;
	float lat(lat) ;
		lat:units = "degrees_north" ;
	float mask(lat, lon) ;
data:

 lon = -177.5, -172.5, -167.5, -162.5, -157.5, -152.5, -147.5, -142.5, 
    -137.5, -132.5, -127.5, -122.5, -117.5, -112.5, -107.5, -102.5, -97.5, 
    -92.5, -87.5, -82.5, -77.5, -72.5, -67.5, -62.5, -57.5, -52.5, -47.5, 
    -42.5, -37.5, -32.5, -27.5, -22.5, -17.5, -12.5, -7.5, -2.5, 2.5, 7.5, 
    12.5, 17.5, 22.5, 27.5, 32.5, 37.5, 42.5, 47.5, 52.5, 57.5, 62.5, 67.5, 
    72.5, 77.5, 82.5, 87.5, 92.5, 97.5, 102.5, 107.5, 112.5, 117.5, 122.5, 
    127.5, 132.5, 137.5, 142.5, 147.5, 152.5, 157.5, 162.5, 167.5, 172.5, 
    177.5 ;

 lat = -89, -86, -82, -78, -74, -70, -66, -62, -58, -54, -50, -46, -42, -38, 
    -34, -30, -26, -22, -18, -14, -10, -6, -2, 2, 6, 10, 14, 18, 22, 26, 30, 
    34, 38, 42, 46, 50, 54, 58, 62, 66, 70, 74, 78, 82, 86, 89 ;

 mask =
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
[...]
#+end_example


** Visualization of GLMELT_4X5.OCN.nc

#+BEGIN_SRC jupyter-python :results verbatim :exports results
import xarray as xr
ds = xr.open_dataset('./dat/GLMELT_4X5.OCN.nc')
_ = ds['mask'].plot()
#+END_SRC

#+ATTR_LATEX: :height 0.9\textheight
#+RESULTS:
[[file:./.ob-jupyter/6a36b8a799a828b667fa6c0bd772b99ad930d9ca.png]]

** Contents of GLMELT_144X90_gas.OCN.nc
:PROPERTIES:
:BEAMER_opt: shrink=6
:END:

#+BEGIN_SRC bash :exports results :results verbatim
ncdump dat/GLMELT_144X90_gas.OCN.nc | head -n40
echo "[...]"
#+END_SRC

#+RESULTS:
#+begin_example
netcdf GLMELT_144X90_gas.OCN {
dimensions:
	lon = 144 ;
	lat = 90 ;
variables:
	float lon(lon) ;
		lon:units = "degrees_east" ;
	float lat(lat) ;
		lat:units = "degrees_north" ;
	float mask(lat, lon) ;
data:

 lon = -178.75, -176.25, -173.75, -171.25, -168.75, -166.25, -163.75, 
    -161.25, -158.75, -156.25, -153.75, -151.25, -148.75, -146.25, -143.75, 
    -141.25, -138.75, -136.25, -133.75, -131.25, -128.75, -126.25, -123.75, 
    -121.25, -118.75, -116.25, -113.75, -111.25, -108.75, -106.25, -103.75, 
    -101.25, -98.75, -96.25, -93.75, -91.25, -88.75, -86.25, -83.75, -81.25, 
    -78.75, -76.25, -73.75, -71.25, -68.75, -66.25, -63.75, -61.25, -58.75, 
    -56.25, -53.75, -51.25, -48.75, -46.25, -43.75, -41.25, -38.75, -36.25, 
    -33.75, -31.25, -28.75, -26.25, -23.75, -21.25, -18.75, -16.25, -13.75, 
    -11.25, -8.75, -6.25, -3.75, -1.25, 1.25, 3.75, 6.25, 8.75, 11.25, 13.75, 
    16.25, 18.75, 21.25, 23.75, 26.25, 28.75, 31.25, 33.75, 36.25, 38.75, 
    41.25, 43.75, 46.25, 48.75, 51.25, 53.75, 56.25, 58.75, 61.25, 63.75, 
    66.25, 68.75, 71.25, 73.75, 76.25, 78.75, 81.25, 83.75, 86.25, 88.75, 
    91.25, 93.75, 96.25, 98.75, 101.25, 103.75, 106.25, 108.75, 111.25, 
    113.75, 116.25, 118.75, 121.25, 123.75, 126.25, 128.75, 131.25, 133.75, 
    136.25, 138.75, 141.25, 143.75, 146.25, 148.75, 151.25, 153.75, 156.25, 
    158.75, 161.25, 163.75, 166.25, 168.75, 171.25, 173.75, 176.25, 178.75 ;

 lat = -89, -87, -85, -83, -81, -79, -77, -75, -73, -71, -69, -67, -65, -63, 
    -61, -59, -57, -55, -53, -51, -49, -47, -45, -43, -41, -39, -37, -35, 
    -33, -31, -29, -27, -25, -23, -21, -19, -17, -15, -13, -11, -9, -7, -5, 
    -3, -1, 1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33, 
    35, 37, 39, 41, 43, 45, 47, 49, 51, 53, 55, 57, 59, 61, 63, 65, 67, 69, 
    71, 73, 75, 77, 79, 81, 83, 85, 87, 89 ;

 mask =
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
[...]
#+end_example


** Visualization of GLMELT_144X90_gas.OCN.nc

#+BEGIN_SRC jupyter-python :results verbatim :exports results
import xarray as xr
ds = xr.open_dataset('./dat/GLMELT_144X90_gas.OCN.nc')
_ = ds['mask'].plot()
#+END_SRC

#+ATTR_LATEX: :height 0.9\textheight
#+RESULTS:
[[file:~/tmp/ob-jupyter-figs/4ae2299e0176cc83b7260b90276f2c9a1f22f10f.png]]


** Actual distribution of melt (Greenland)
*** Code                                                   :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.6
:END:

#+NAME: mb_distribution
#+BEGIN_SRC jupyter-python :exports both
import xarray as xr
ds = xr.open_dataset('./input/mankoff_2021.nc')
df = ds['MB_ROI']\
    .rename('Mass loss [%]')\
    .mean(dim='time')\
    .to_dataframe()\
    .abs()

norm_df = df * (1/df.sum())
norm_df = (norm_df * 100).round().astype(int)
norm_df.loc['TOTAL'] = norm_df.sum()
norm_df
#+END_SRC

*** Results                                                :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.4
:END:

#+RESULTS: mb_distribution
| region | Mass loss [%] |
|--------+---------------|
| NE     |            12 |
| CE     |             1 |
| SE     |             6 |
| SW     |             6 |
| CW     |            24 |
| NW     |            32 |
| NO     |            19 |
| TOTAL  |           100 |

** Mask editing                                         :noexport:
*** Make mask QGIS compatible

+ Cannot do, currently, with 4x5.
  + https://lists.osgeo.org/pipermail/gdal-dev/2023-January/056767.html
  + https://github.com/OSGeo/gdal/pull/7113


#+BEGIN_SRC jupyter-python
import xarray as xr

fname = "GLMELT_144X90_gas.OCN.nc"
ds = xr.open_dataset("./dat/" + fname)

ds["crs"] = True
ds["crs"].attrs["grid_mapping_name"] = "latitude_longitude"

ds["mask"].attrs["grid_mapping"] = "crs"
ds["mask"].attrs["_FillValue"] = 0 # optional

ds.to_netcdf("./dat/" + fname[:-3] + ".crs.nc")
#+END_SRC


#+BEGIN_SRC bash
ncap2 -h -O -s 'crs=1B' ./dat/GLMELT_144X90_gas.OCN.nc ./dat/GLMELT_144X90_gas.OCN.v2.nc

ncatted -h -O \
    -a grid_mapping_name,crs,c,c,'latitude_longitude' \
    -a grid_mapping,mask,c,c,'crs' \
    -a _FillValue,mask,c,c,0 \
     ./dat/GLMELT_144X90_gas.OCN.v2.nc
#+END_SRC

#+RESULTS:


#+BEGIN_SRC bash :results verbatim
ncdump -chs ./dat/GLMELT_144X90_gas.OCN.crs.nc
#+END_SRC

#+RESULTS:
#+begin_example
netcdf GLMELT_144X90_gas.OCN.crs {
dimensions:
	lon = 144 ;
	lat = 90 ;
variables:
	float lon(lon) ;
		lon:_FillValue = NaNf ;
		lon:units = "degrees_east" ;
		lon:_Storage = "contiguous" ;
		lon:_Endianness = "little" ;
	float lat(lat) ;
		lat:_FillValue = NaNf ;
		lat:units = "degrees_north" ;
		lat:_Storage = "contiguous" ;
		lat:_Endianness = "little" ;
	float mask(lat, lon) ;
		mask:_FillValue = 0.f ;
		mask:grid_mapping = "crs" ;
		mask:_Storage = "contiguous" ;
		mask:_Endianness = "little" ;
	byte crs ;
		crs:grid_mapping_name = "latitude_longitude" ;
		crs:dtype = "bool" ;
		crs:_Storage = "contiguous" ;

// global attributes:
		:_NCProperties = "version=2,netcdf=4.8.1,hdf5=1.12.1" ;
		:_SuperblockVersion = 2 ;
		:_IsNetcdf4 = 1 ;
		:_Format = "netCDF-4" ;
}
#+end_example

*** Print locations (NH; 4x5)
#+BEGIN_SRC jupyter-python
import xarray as xr
ds = xr.open_dataset('./dat/GLMELT_4X5.OCN.nc')

ds = ds.where((ds['mask'] == 1) & (ds['lat'] > 0))
da_stacked = ds['mask'].stack(notnull=['lat','lon'])
dd = da_stacked[da_stacked.notnull()]
# print(dd)
df = pd.DataFrame([_ for _ in zip(dd['lat'].values,dd['lon'].values,dd.values)],
                  columns=['lat','lon','mask'])

# df.set_index(['lat','lon'])
df
#+END_SRC

#+RESULTS:
|   | lat |   lon | mask |
|---+-----+-------+------|
| 0 |  62 | -52.5 |    1 |
| 1 |  62 | -37.5 |    1 |
| 2 |  66 | -57.5 |    1 |
| 3 |  66 | -37.5 |    1 |
| 4 |  66 | -32.5 |    1 |
| 5 |  66 | -27.5 |    1 |
| 6 |  70 | -57.5 |    1 |
| 7 |  70 | -22.5 |    1 |
| 8 |  74 | -57.5 |    1 |
| 9 |  74 | -17.5 |    1 |


*** Print locations (NH; 2.5x2)
#+BEGIN_SRC jupyter-python
import xarray as xr
melt = xr.open_dataset('./dat/GLMELT_4X5.OCN.nc')
cl = xr.open_dataset('./dat/Z2HX2fromZ1QX1N.BS1.nc')
ds = melt.merge(cl)

ds = ds.where((ds['mask'] == 1) & (ds['lat'] > 0))

st = ds.stack(notnull=['lat','lon'])
da_stacked = ds['mask'].stack(notnull=['lat','lon'])
dd = da_stacked[da_stacked.notnull()]
# print(dd)
df = pd.DataFrame([_ for _ in zip(dd['lat'].values,dd['lon'].values,dd.values)],
                  columns=['lat','lon','mask'])

# df.set_index(['lat','lon'])
df
#+END_SRC

#+RESULTS:
|   | lat |   lon | mask |
|---+-----+-------+------|
| 0 |  62 | -52.5 |    1 |
| 1 |  62 | -37.5 |    1 |
| 2 |  66 | -57.5 |    1 |
| 3 |  66 | -37.5 |    1 |
| 4 |  66 | -32.5 |    1 |
| 5 |  66 | -27.5 |    1 |
| 6 |  70 | -57.5 |    1 |
| 7 |  70 | -22.5 |    1 |
| 8 |  74 | -57.5 |    1 |
| 9 |  74 | -17.5 |    1 |


*** SST boundary

+ Compare GLMELT and OST SST fields spatially...

#+BEGIN_SRC jupyter-python :results verbatim :exports results
import xarray as xr
import matplotlib.pyplot as plt

glmelt = xr.open_dataset('./dat/GLMELT_144X90_gas.OCN.nc')
glmelt = glmelt.where(glmelt['mask'] != 0)

land = xr.open_dataset('./dat/Z2HX2fromZ1QX1N.BS1.nc')

plt.clf()
_ = land['focean'].plot()
_ = glmelt['mask'].plot(cmap=plt.cm.Blues)
#+END_SRC

#+RESULTS:

*** Label locations (4x5)
#+BEGIN_SRC jupyter-python
import xarray as xr
ds = xr.open_dataset('./dat/GLMELT_4X5.OCN.nc')

ds['region'] = (('lat','lon'), (ds.mask.values).astype(str))

ds['region'][27,38] = 'SW'
ds['region'][26,39] = 'SW'
ds['region'][25,40] = 'SW'

ds['region'][27,38] = 'SE'
ds['region'][27,38] = 'SE'
ds['region'][27,38] = 'SE'


ds = ds.where(ds['mask'] == 1)
da_stacked = ds['mask'].stack(notnull=['lat','lon'])
dd = da_stacked[da_stacked.notnull()]
# print(dd)
df = pd.DataFrame([_ for _ in zip(dd['lat'].values,dd['lon'].values,dd.values)],
                  columns=['lat','lon','mask'])

# df.set_index(['lat','lon'])
df
#+END_SRC

#+RESULTS:
|     | lat |    lon | mask |
|-----+-----+--------+------|
|   0 | -78 | -177.5 |    1 |
|   1 | -78 | -172.5 |    1 |
|   2 | -78 | -167.5 |    1 |
|   3 | -78 | -162.5 |    1 |
|   4 | -78 |  -42.5 |    1 |
|   5 | -78 |  -37.5 |    1 |
|   6 | -78 |  177.5 |    1 |
|   7 | -74 | -177.5 |    1 |
|   8 | -74 | -172.5 |    1 |
|   9 | -74 | -167.5 |    1 |
|  10 | -74 | -162.5 |    1 |
|  11 | -74 | -157.5 |    1 |
|  12 | -74 | -152.5 |    1 |
|  13 | -74 | -147.5 |    1 |
|  14 | -74 | -142.5 |    1 |
|  15 | -74 | -137.5 |    1 |
|  16 | -74 | -132.5 |    1 |
|  17 | -74 | -127.5 |    1 |
|  18 | -74 |  -57.5 |    1 |
|  19 | -74 |  -52.5 |    1 |
|  20 | -74 |  -47.5 |    1 |
|  21 | -74 |  -42.5 |    1 |
|  22 | -74 |  -37.5 |    1 |
|  23 | -74 |  -32.5 |    1 |
|  24 | -74 |  -27.5 |    1 |
|  25 | -74 |  -22.5 |    1 |
|  26 | -74 |  167.5 |    1 |
|  27 | -74 |  172.5 |    1 |
|  28 | -74 |  177.5 |    1 |
|  29 | -70 | -177.5 |    1 |
|  30 | -70 | -172.5 |    1 |
|  31 | -70 | -167.5 |    1 |
|  32 | -70 | -162.5 |    1 |
|  33 | -70 | -157.5 |    1 |
|  34 | -70 | -152.5 |    1 |
|  35 | -70 | -147.5 |    1 |
|  36 | -70 | -142.5 |    1 |
|  37 | -70 | -137.5 |    1 |
|  38 | -70 | -132.5 |    1 |
|  39 | -70 | -127.5 |    1 |
|  40 | -70 |  -57.5 |    1 |
|  41 | -70 |  -52.5 |    1 |
|  42 | -70 |  -47.5 |    1 |
|  43 | -70 |  -42.5 |    1 |
|  44 | -70 |  -37.5 |    1 |
|  45 | -70 |  -32.5 |    1 |
|  46 | -70 |  -27.5 |    1 |
|  47 | -70 |  -22.5 |    1 |
|  48 | -70 |  -17.5 |    1 |
|  49 | -70 |  -12.5 |    1 |
|  50 | -70 |   -7.5 |    1 |
|  51 | -70 |   -2.5 |    1 |
|  52 | -70 |  162.5 |    1 |
|  53 | -70 |  167.5 |    1 |
|  54 | -70 |  172.5 |    1 |
|  55 | -70 |  177.5 |    1 |
|  56 | -66 | -177.5 |    1 |
|  57 | -66 | -172.5 |    1 |
|  58 | -66 | -167.5 |    1 |
|  59 | -66 | -162.5 |    1 |
|  60 | -66 | -157.5 |    1 |
|  61 | -66 | -152.5 |    1 |
|  62 | -66 | -147.5 |    1 |
|  63 | -66 | -142.5 |    1 |
|  64 | -66 | -137.5 |    1 |
|  65 | -66 | -132.5 |    1 |
|  66 | -66 | -127.5 |    1 |
|  67 | -66 |  -57.5 |    1 |
|  68 | -66 |  -52.5 |    1 |
|  69 | -66 |  -47.5 |    1 |
|  70 | -66 |  -42.5 |    1 |
|  71 | -66 |  -37.5 |    1 |
|  72 | -66 |  -32.5 |    1 |
|  73 | -66 |  -27.5 |    1 |
|  74 | -66 |  -22.5 |    1 |
|  75 | -66 |  -17.5 |    1 |
|  76 | -66 |  -12.5 |    1 |
|  77 | -66 |   -7.5 |    1 |
|  78 | -66 |   -2.5 |    1 |
|  79 | -66 |  162.5 |    1 |
|  80 | -66 |  167.5 |    1 |
|  81 | -66 |  172.5 |    1 |
|  82 | -66 |  177.5 |    1 |
|  83 | -62 | -177.5 |    1 |
|  84 | -62 | -172.5 |    1 |
|  85 | -62 | -167.5 |    1 |
|  86 | -62 | -162.5 |    1 |
|  87 | -62 | -157.5 |    1 |
|  88 | -62 | -152.5 |    1 |
|  89 | -62 | -147.5 |    1 |
|  90 | -62 | -142.5 |    1 |
|  91 | -62 | -137.5 |    1 |
|  92 | -62 | -132.5 |    1 |
|  93 | -62 | -127.5 |    1 |
|  94 | -62 |  -62.5 |    1 |
|  95 | -62 |  -57.5 |    1 |
|  96 | -62 |  -52.5 |    1 |
|  97 | -62 |  -47.5 |    1 |
|  98 | -62 |  -42.5 |    1 |
|  99 | -62 |  -37.5 |    1 |
| 100 | -62 |  -32.5 |    1 |
| 101 | -62 |  -27.5 |    1 |
| 102 | -62 |  -22.5 |    1 |
| 103 | -62 |  -17.5 |    1 |
| 104 | -62 |  -12.5 |    1 |
| 105 | -62 |   -7.5 |    1 |
| 106 | -62 |   -2.5 |    1 |
| 107 | -62 |  162.5 |    1 |
| 108 | -62 |  167.5 |    1 |
| 109 | -62 |  172.5 |    1 |
| 110 | -62 |  177.5 |    1 |
| 111 |  62 |  -52.5 |    1 |
| 112 |  62 |  -37.5 |    1 |
| 113 |  66 |  -57.5 |    1 |
| 114 |  66 |  -37.5 |    1 |
| 115 |  66 |  -32.5 |    1 |
| 116 |  66 |  -27.5 |    1 |
| 117 |  70 |  -57.5 |    1 |
| 118 |  70 |  -22.5 |    1 |
| 119 |  74 |  -57.5 |    1 |
| 120 |  74 |  -17.5 |    1 |


* Antarctica

** IMBIE 2018

+ IMBIE citep:the-imbie-team_2018 has a longer records: 1992 through 2018 (and ongoing updates)
+ http://imbie.org/data-downloads/

** IMBIE 2018 vs Slater 2021

*** Text                                                   :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:

Bottom panel
+ Blue line is same as middle panel
+ Green line is:
  + Blue line (Grounded ice) +
  + Southern hemisphere sea ice +
  + Ice shelf calving +
  + Ice shelf thinning

*** Figure                                                 :BMCOL:
:PROPERTIES:
:BEAMER_col: 0.5
:END:
#+BEGIN_SRC bash
wget -q http://imbie.org/data-files/imbie_dataset-2018_07_23.xlsx
mv imbie_dataset-2018_07_23.xlsx ./input
md5sum ./input/imbie_dataset-2018_07_23.xlsx
#+END_SRC

#+RESULTS:
: 0428261d001f8e3b8a18d43e6f29b629  ./input/imbie_dataset-2018_07_23.xlsx
  
#+BEGIN_SRC jupyter-python :exports results
import numpy as np
import pandas as pd
from datetime import datetime
from datetime import timedelta
import matplotlib.pyplot as plt

def convert_partial_year(number):
    year = int(number)
    d = timedelta(days=(number - year)*365)
    day_one = datetime(year,1,1)
    date = d + day_one
    return date.date()


imbie = pd.read_excel('./input/imbie_dataset-2018_07_23.xlsx')\
    .rename(columns={'Cumulative ice mass change (Gt)':'IMBIE',
                     'Cumulative ice mass change uncertainty (Gt)':'IMBIE err'})\
    .drop(columns=['Cumulative sea level contribution (mm)',
                   'Cumulative sea level contribution uncertainty (mm)'])

imbie.index = pd.to_datetime([convert_partial_year(_) for _ in imbie['Year']])
imbie = imbie.drop(columns='Year')

# imbie = imbie.resample('1D').interpolate(dim='time').resample('YS').mean()
imbie = imbie.resample('YS').mean()



kw = {'parse_dates':True, 'index_col':0}
SH_ice = pd.read_csv('./input/SH_seaice_cumul_1994_2017_annual.csv', names=['Antarctic Sea Ice'], **kw)
shelf_calving = pd.read_csv('./input/iceshelves_calving_cumul_1994_2017_annual.csv', names=['Ice Shelf Calving'], **kw)
shelf_thinning = pd.read_csv('./input/iceshelves_thinning_cumul_1994_2017_annual.csv', names=['Ice Shelf Thinning'], **kw)
AQ = pd.read_csv('./input/AIS_cumul_1994_2017_annual.csv', names=['Antarctica'], **kw)
kw = {'left_index':True, 'right_index':True, 'how':'outer'}
S2021 = SH_ice.merge(shelf_calving, **kw)\
           .merge(shelf_thinning, **kw)\
           .merge(AQ, **kw)
S2021.index.name = 'Date'
# S2021 = S2021.sum(axis='columns')
# S2021.name = 'Slater 2021'
# S2021 = pd.read_csv('./input/AIS_cumul_1994_2017_annual.csv', names=['Slater 2021'], **kw)


df = imbie.merge(S2021, left_index=True, right_index=True, how='outer')
df.index.name = 'Date'

for _ in df.columns: # extend by 1 year for plotting w/ 'step'
    df.loc[df[_].dropna().index[-1] + pd.offsets.DateOffset(years=1),_] = df[_].dropna().iloc[-1]

fig, (ax, ax2, ax3) = plt.subplots(nrows=3, figsize=(4,7))
kw = {'drawstyle':'steps'}
(df['IMBIE']).diff().plot(ax=ax, **kw)
(df['Antarctica']).diff().plot(ax=ax, **kw)
ax.set_ylabel('Annual\nmass change [Gt]')
(df['IMBIE'] - df['Antarctica']).diff().plot(ax=ax, linestyle='--', color='k', alpha=0.5, **kw)

df[['IMBIE','Antarctica']]\
    .rename(columns={'Antarctica':'Slater 2021 (AQ)'})\
    .plot(ax=ax2, **kw)
_ = ax2.set_ylabel('Cumulative\nmass change [Gt]')
ax2r = ax2.twinx()
ax2r.set_ylim(np.array(ax2.get_ylim()).astype(float)/-362)
ax2r.set_ylabel('SLR [mm]')

df[['Antarctica']]\
    .rename(columns={'Antarctica':'AQ only (grounded)'})\
    .plot(ax=ax3, **kw)
df[['Antarctica',
    'Ice Shelf Calving',
    'Ice Shelf Thinning'
    ]]\
    .sum(axis='columns')\
    [:'2015-12-31']\
    .plot(ax=ax3, color='green', **kw)
ax3.legend(['Grounded only (middle panel)','IS Calv + IC Thin + AQ'], fontsize=8)
_ = ax3.set_ylabel('Cumulative\nfreshwater mass [Gt]')
#+END_SRC

#+ATTR_LATEX: :height 0.9\textheight
#+RESULTS:
[[file:./.ob-jupyter/fc07e4a0fe422414ee969936ad5676f7f6dec11b.png]]



* Summary
** Question

+ [ ] How to extend time series?
+ [ ] Where is high-res (1x1) =GLMELT= mask located?
+ [ ] Should we include Arctic Sea Ice & Antarctic Sea Ice changes?
  + [ ] If so, on what mask?
+ [ ] How to define new mask?
  + [ ] Regional contribution to mass loss
+ [ ] Should we redefine baseline mask?
  + [ ] Currently is 1 everywhere (uniform spread)
  + [ ] Should be based on only negative mass terms
    + Surface melt
    + Iceberg discharge & submarine melt
    + [ ] Parameterize iceberg drift and melt to far-field?

** To Do

+ [ ] Write freshwater anomaly to ModelE file format
+ [ ] Create new mask
  + [ ] Redefine baseline mask
+ [ ] Modify ModelE to use new mask + FW forcing

* Appendix                                            :B_appendix:
:PROPERTIES:
:BEAMER_env: appendix
:END:
** References
:PROPERTIES:
:BEAMER_opt: allowframebreaks,label=
:END:

#+LATEX_HEADER_EXTRA: \renewcommand*{\bibfont}{\small}
\printbibliography[heading=none]

** About This Document
# :PROPERTIES:
# :BEAMER_opt: shrink=10
# :END:

This document is an Emacs Org Mode plain-text file with code and text
embedded. If you are viewing:
+ A PDF, HTML, or DOC file, then it was generated by exporting from Org. Not all of the Org parts (code, results, comments, etc.) were exported. The Org source file is available upon request, and may be embedded in the PDF. You can access files embedded in PDF files with from within your PDF viewer.
+ A file with an ~org~ extension in something other than Emacs, then you are seeing the canonical version and the full source, but without any syntax highlighting, document structure, or the ability to execute the code blocks.
+ An ~Org~ file within Emacs, then this is the canonical version. You should be able to fully interact and reproduce the contents of this document, although it may require 3rd-party applications (Python, etc.) and a similar Emacs configuration. This is available upon request.

* LaTeX Header                                          :noexport:
** Beamer

#+STARTUP: beamer
#+LaTeX_CLASS_OPTIONS: [presentation, smaller, compress, aspectratio=169]
#+COLUMNS: %45ITEM %10BEAMER_env(Env) %10BEAMER_act(Act) %4BEAMER_col(Col) %8BEAMER_opt(Opt)
#+PROPERTY: BEAMER_col_ALL 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9 0.0 :ETC

*** Title Page

#+BEAMER_HEADER: \subtitle{GL \& AQ}
#+BEAMER_HEADER: \institute[]{NASA GISS}

#+BEAMER_HEADER: \titlegraphic{\includegraphics[height=1.0cm]{/home/kdm/Documents/templates/logos/NASA.png}}

# #+BEAMER_HEADER: \logo{\includegraphics[height=1.0cm]{/home/kdm/Documents/templates/logos/NASA.png}}

*** Theme

#+BEAMER_THEME: Frankfurt
#+BEAMER_COLOR_THEME: seagull

#+BEAMER_HEADER: \setbeamertemplate{navigation symbols}{}

#+BEAMER_HEADER: \setbeamercolor*{block title alerted}{bg=yellow!50}
#+BEAMER_HEADER: \setbeamercolor*{block body alerted}{bg=yellow!30}
#+BEAMER_HEADER: \setbeamertemplate{blocks}[rounded][shadow=true]

#+BEAMER_HEADER: \setbeamercovered{transparent=30} % preview hidden content
# #+BEAMER_HEADER: \setbeamercovered{invisible}


#+BEAMER_HEADER: \setbeamertemplate{footline}{}

#+BEAMER_HEADER: \setbeamertemplate{frametitle}{%
#+BEAMER_HEADER:   \nointerlineskip
#+BEAMER_HEADER:     \begin{beamercolorbox}[sep=0.1cm,wd=\paperwidth,leftskip=.2cm,rightskip=0cm]{frametitle}%
#+BEAMER_HEADER:       \usebeamerfont{frametitle}\usebeamercolor[fg]{frametitle}\insertframetitle\\
#+BEAMER_HEADER:       \usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle
#+BEAMER_HEADER:     \end{beamercolorbox}%
#+BEAMER_HEADER: }

#+BEAMER_HEADER: \usepackage{tikz}
#+BEAMER_HEADER: \addtobeamertemplate{frametitle}{}{%
#+BEAMER_HEADER: \begin{tikzpicture}[remember picture,overlay]
#+BEAMER_HEADER:   \node[anchor=south east,yshift=0pt] at (current page.south east) {\includegraphics[height=1cm]{/home/kdm/Documents/templates/logos/NASA.png}};
#+BEAMER_HEADER: \end{tikzpicture}\vspace{-0.4cm}}

#+BEAMER_HEADER: \addtobeamertemplate{frametitle}{}{\tikz[overlay, remember picture] \node[anchor=south west,yshift=1pt] at (current page.south west){{\tiny\textcolor{gray}{\insertframenumber}}};}

# #+BEAMER_HEADER: \setbeamerfont{headline}{size=\small}
#+BEAMER_HEADER: \setbeamerfont{frametitle}{size=\Large}
# \tiny \scriptsize \footnotesize \small \normalsize \large \Large \huge \Huge

# (setq org-latex-listings nil)

# #+INCLUDE: "./listings.org"
# #+LaTeX: \setbeamercolor*{block title verbatim}{bg=yellow!50}
# #+LaTeX: \setbeamercolor*{block body verbatim}{bg=yellow!30}

*** COMMENT Presenter Notes


%% Presenter Notes
#+BEAMER_HEADER: \usepackage{pgfpages}
#+BEAMER_HEADER: \setbeameroption{show notes on second screen}
# #+BEAMER_HEADER: \setbeameroption{show notes on second screen=left}
# #+BEAMER_HEADER: \setbeamertemplate{note page}[plain]

# #+BEAMER_HEADER: \usepackage{handoutWithNotes}
# #+BEAMER_HEADER: \pgfpagesuselayout{4 on 1 with notes}[a4paper,border shrink=5mm]

*** Other

#+BEAMER_HEADER: \usepackage{multimedia}
#+BEAMER_HEADER: \usepackage{lxfonts}
#+BEAMER_HEADER: \usefonttheme{professionalfonts}

#+BEAMER_HEADER: \newcommand\bgimage[1]{%
#+BEAMER_HEADER: \begin{backgroundblock}{-1mm}{0mm}
#+BEAMER_HEADER: \includegraphics[height=\paperheight]{#1}
#+BEAMER_HEADER: \end{backgroundblock}}

#+BEAMER_HEADER: \newcommand\bgimagewide[1]{%
#+BEAMER_HEADER: \begin{backgroundblock}{-1mm}{15mm}
#+BEAMER_HEADER: \includegraphics[width=\paperwidth]{#1}
#+BEAMER_HEADER: \end{backgroundblock}}

#+BEAMER_HEADER: \usepackage[outline]{contour}
#+BEAMER_HEADER: \usepackage[absolute,overlay]{textpos}
#+BEAMER_HEADER: \newcommand\footertext[1]{%
#+BEAMER_HEADER:   \begin{textblock*}{\paperwidth}(1em,0.95\paperheight)
#+BEAMER_HEADER:     \contour{red}\protect\textcolor{black}{\small{#1}}
#+BEAMER_HEADER:   \end{textblock*}}

# #+LATEX_HEADER: \newcommand*{\TakeFourierOrnament}[1]{{%
# #+LATEX_HEADER: \fontencoding{U}\fontfamily{futs}\selectfont\char#1}}
# #+LATEX_HEADER: \newcommand*{\danger}{\TakeFourierOrnament{66}}
#+LATEX_HEADER: \usepackage{fontawesome}

** References

#+LATEX_HEADER_EXTRA:%\usepackage[bibstyle=authoryear,firstinits=true,maxbibnames=99]{biblatex}
#+LATEX_HEADER_EXTRA: \usepackage[hyperref=true,
#+LATEX_HEADER_EXTRA:             %sorting=none, 
#+LATEX_HEADER_EXTRA:             sorting=nyt,
#+LATEX_HEADER_EXTRA:             %style=numeric, 
#+LATEX_HEADER_EXTRA:             style=authoryear,
#+LATEX_HEADER_EXTRA:             %defernumbers=true, 
#+LATEX_HEADER_EXTRA:             firstinits=true, 
#+LATEX_HEADER_EXTRA:             uniquename=false,
#+LATEX_HEADER_EXTRA:             uniquelist=false,
#+LATEX_HEADER_EXTRA:             %uniquelist=minyear,
#+LATEX_HEADER_EXTRA:             maxnames=99, 
#+LATEX_HEADER_EXTRA:             backend=biber,
#+LATEX_HEADER_EXTRA:             bibenconding=utf8,
#+LATEX_HEADER_EXTRA:             maxcitenames=2]{biblatex}
#+LATEX_HEADER_EXTRA:\addbibresource{/home/kdm/Documents/Papers/library.bib}
#+LATEX_HEADER_EXTRA:\addbibresource{/home/kdm/Documents/Papers/software.bib}
#+LATEX_HEADER_EXTRA:\addbibresource{/home/kdm/Documents/Papers/data.bib}
#+LATEX_HEADER_EXTRA: \renewbibmacro{in:}{}
#+LATEX_HEADER_EXTRA: \renewcommand*{\bibfont}{\footnotesize}

# biber <texfile><.NOEXT> --output_format bibtex

#+LATEX_HEADER_EXTRA: \usepackage{xpatch}
#+LATEX_HEADER_EXTRA: \xpatchbibmacro{name:andothers}{%
#+LATEX_HEADER_EXTRA:   \bibstring{andothers}%
#+LATEX_HEADER_EXTRA: }{%
#+LATEX_HEADER_EXTRA:   \bibstring[\emph]{andothers}%
#+LATEX_HEADER_EXTRA: }{}{}

# http://tex.stackexchange.com/a/5779/360
#+LATEX_HEADER_EXTRA: % Don't print URL if DOI field exists
#+LATEX_HEADER_EXTRA: \DeclareFieldFormat{url}{%
#+LATEX_HEADER_EXTRA:   \iffieldundef{doi}{%
#+LATEX_HEADER_EXTRA:     \mkbibacro{URL}\addcolon\space\url{#1}%
#+LATEX_HEADER_EXTRA:   }{%
#+LATEX_HEADER_EXTRA:   }%
#+LATEX_HEADER_EXTRA: }
#+LATEX_HEADER_EXTRA: % Don't print URL if DOI field exists
#+LATEX_HEADER_EXTRA: \DeclareFieldFormat{urldate}{%
#+LATEX_HEADER_EXTRA:   \iffieldundef{doi}{%
#+LATEX_HEADER_EXTRA:     \mkbibparens{\bibstring{urlseen}\space#1}%
#+LATEX_HEADER_EXTRA:   }{%
#+LATEX_HEADER_EXTRA:   }%
#+LATEX_HEADER_EXTRA: }

#+LATEX_HEADER_EXTRA: \renewbibmacro*{journal+issuetitle}{%
#+LATEX_HEADER_EXTRA: \usebibmacro{journal}%
#+LATEX_HEADER_EXTRA: \setunit*{\addspace}%
#+LATEX_HEADER_EXTRA: \iffieldundef{series}
#+LATEX_HEADER_EXTRA: {}
#+LATEX_HEADER_EXTRA: {\newunit
#+LATEX_HEADER_EXTRA: \printfield{series}%
#+LATEX_HEADER_EXTRA: \setunit{\addspace}}%
#+LATEX_HEADER_EXTRA: \usebibmacro{issue+date}%
#+LATEX_HEADER_EXTRA: \setunit{\addcomma\space}%
#+LATEX_HEADER_EXTRA: \usebibmacro{volume+number+eid}%
#+LATEX_HEADER_EXTRA: \setunit{\addcolon\space}%
#+LATEX_HEADER_EXTRA: \usebibmacro{issue}%
#+LATEX_HEADER_EXTRA: \newunit}

#+LATEX_HEADER_EXTRA: \newbibmacro*{issue+date}{%
#+LATEX_HEADER_EXTRA: \iffieldundef{issue}
#+LATEX_HEADER_EXTRA: {. \usebibmacro{date}}
#+LATEX_HEADER_EXTRA: {\printfield{issue}%
#+LATEX_HEADER_EXTRA: \setunit*{\addspace}%
#+LATEX_HEADER_EXTRA: \usebibmacro{date}}%
#+LATEX_HEADER_EXTRA: \newunit}

#+LATEX_HEADER_EXTRA: \renewbibmacro*{volume+number+eid}{%
#+LATEX_HEADER_EXTRA: \printfield{volume}%
#+LATEX_HEADER_EXTRA: \setunit*{\addnbspace}% NEW (optional); there's also #+LATEX_HEADER_EXTRA: \addnbthinspace
#+LATEX_HEADER_EXTRA: \printfield{number}%
#+LATEX_HEADER_EXTRA: \setunit{\addcomma\space}%
#+LATEX_HEADER_EXTRA: \printfield{eid}}
#+LATEX_HEADER_EXTRA: \DeclareFieldFormat[article]{number}{\mkbibparens{#1}}

#+LATEX_HEADER_EXTRA: \DeclareFieldFormat{pages}{#1}

** Hyperref
#+LATEX_HEADER_EXTRA:  %\usepackage{datetime}\renewcommand{\dateseparator}{-}
#+LATEX_HEADER_EXTRA:  \usepackage{xspace} % smart spaces
#+LATEX_HEADER_EXTRA:  \hypersetup{
#+LATEX_HEADER_EXTRA:    colorlinks=true,       % links are colored
#+LATEX_HEADER_EXTRA:    urlcolor=blue,    % color of external links
#+LATEX_HEADER_EXTRA:    linkcolor=blue,   % color of internal links
#+LATEX_HEADER_EXTRA:    citecolor=gray,   % color of links to bibliography
#+LATEX_HEADER_EXTRA:    draft=false, % link even in draft mode
#+LATEX_HEADER_EXTRA:    bookmarksopen=true, % ?
#+LATEX_HEADER_EXTRA:    pdfdisplaydoctitle=true}
#+LATEX_HEADER_EXTRA:  \renewcommand{\textfraction}{0.05}
#+LATEX_HEADER_EXTRA:  \renewcommand{\topfraction}{0.8}
#+LATEX_HEADER_EXTRA:  \renewcommand{\bottomfraction}{0.8}
#+LATEX_HEADER_EXTRA:  \renewcommand{\floatpagefraction}{0.75}

** Tweak References

# Make citations smaller 
# #+LATEX_HEADER_EXTRA: \let\realtextcite=\textcite
# #+LATEX_HEADER_EXTRA: \renewcommand{\textcite}[1]{{\scriptsize\textcolor{gray}{\realtextcite{#1}}}}
# #+LATEX_HEADER_EXTRA: \let\realautocite=\autocite
# #+LATEX_HEADER_EXTRA: \renewcommand{\autocite}[1]{{\scriptsize\textcolor{gray}{\realautocite{#1}}}}

#+LATEX_HEADER_EXTRA: \let\realtextcite=\textcite
#+LATEX_HEADER_EXTRA: \renewcommand{\textcite}[1]{{\textcolor{gray}{\realtextcite{#1}}}}
#+LATEX_HEADER_EXTRA: \let\realautocite=\autocite
#+LATEX_HEADER_EXTRA: \renewcommand{\autocite}[1]{{\textcolor{gray}{\realautocite{#1}}}}


** Background Block

# https://tex.stackexchange.com/questions/133955/beamer-how-to-place-images-behind-text-z-order
# % beamer: How to place images behind text (z-order) (http://tex.stackexchange.com/a/134311)
#+LATEX_HEADER_EXTRA: \makeatletter
#+LATEX_HEADER_EXTRA: \newbox\@backgroundblock
#+LATEX_HEADER_EXTRA: \newenvironment{backgroundblock}[2]{%
#+LATEX_HEADER_EXTRA:   \global\setbox\@backgroundblock=\vbox\bgroup%
#+LATEX_HEADER_EXTRA:     \unvbox\@backgroundblock%
#+LATEX_HEADER_EXTRA:     \vbox to0pt\bgroup\vskip#2\hbox to0pt\bgroup\hskip#1\relax%
#+LATEX_HEADER_EXTRA: }{\egroup\egroup\egroup}
#+LATEX_HEADER_EXTRA: \addtobeamertemplate{background}{\box\@backgroundblock}{}
#+LATEX_HEADER_EXTRA: \makeatother

# \begin{backgroundblock}{-3mm}{9mm}
# \includegraphics[height=\textheight]{./fig/Q.png}
# \end{backgroundblock}

** Code export

# (add-to-list 'org-latex-packages-alist '("minted"))
# (setq org-latex-listings 'minted)
# (setq org-latex-packages-alist nil)
# (setq org-latex-listings nil)

** COMMENT Embedded file
#+LATEX_HEADER_EXTRA: \usepackage{embedfile}
#+LATEX_HEADER_EXTRA: \embedfile{\jobname.org}

# \usepackage[main,include]{embedall}
# \IfFileExists{./\jobname.org}{\embedfile[desc=The original file]{\jobname.org}}{}

* Local Variables                                       :noexport:

# Local Variables:
# eval: (org-babel-lob-ingest "./lob.org")
# End:
